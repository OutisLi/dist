<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>2024.02.26-2.4 Sequential Logic</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.9f84806b.css" as="style"><link rel="preload" href="/assets/js/app.aca65f08.js" as="script"><link rel="preload" href="/assets/js/2.0c4bddf9.js" as="script"><link rel="preload" href="/assets/js/1.50b457b8.js" as="script"><link rel="preload" href="/assets/js/35.3ddbf166.js" as="script"><link rel="prefetch" href="/assets/js/10.325b9f09.js"><link rel="prefetch" href="/assets/js/11.845e3692.js"><link rel="prefetch" href="/assets/js/12.ecdb524b.js"><link rel="prefetch" href="/assets/js/13.3f3f6a36.js"><link rel="prefetch" href="/assets/js/14.eb7a3d07.js"><link rel="prefetch" href="/assets/js/15.b60f3925.js"><link rel="prefetch" href="/assets/js/16.85253907.js"><link rel="prefetch" href="/assets/js/17.c2838453.js"><link rel="prefetch" href="/assets/js/18.3256f17f.js"><link rel="prefetch" href="/assets/js/19.d8afd0ae.js"><link rel="prefetch" href="/assets/js/20.10e47ab9.js"><link rel="prefetch" href="/assets/js/21.33b300c9.js"><link rel="prefetch" href="/assets/js/22.62284270.js"><link rel="prefetch" href="/assets/js/23.7db5debe.js"><link rel="prefetch" href="/assets/js/24.c7d90f40.js"><link rel="prefetch" href="/assets/js/25.6eea5c7e.js"><link rel="prefetch" href="/assets/js/26.9050baa1.js"><link rel="prefetch" href="/assets/js/27.580760bf.js"><link rel="prefetch" href="/assets/js/28.de97261b.js"><link rel="prefetch" href="/assets/js/29.6c399461.js"><link rel="prefetch" href="/assets/js/3.af33e5d6.js"><link rel="prefetch" href="/assets/js/30.0d308e4d.js"><link rel="prefetch" href="/assets/js/31.e3d87865.js"><link rel="prefetch" href="/assets/js/32.06d47597.js"><link rel="prefetch" href="/assets/js/33.b2f53157.js"><link rel="prefetch" href="/assets/js/34.b56caa5e.js"><link rel="prefetch" href="/assets/js/36.39948275.js"><link rel="prefetch" href="/assets/js/37.0d9f8801.js"><link rel="prefetch" href="/assets/js/38.fb00ff7f.js"><link rel="prefetch" href="/assets/js/39.336735c7.js"><link rel="prefetch" href="/assets/js/4.45665f8a.js"><link rel="prefetch" href="/assets/js/40.89589368.js"><link rel="prefetch" href="/assets/js/41.f8b893e2.js"><link rel="prefetch" href="/assets/js/42.02e366b2.js"><link rel="prefetch" href="/assets/js/43.04786f37.js"><link rel="prefetch" href="/assets/js/44.33f8b3ae.js"><link rel="prefetch" href="/assets/js/45.acb58579.js"><link rel="prefetch" href="/assets/js/46.26b94de1.js"><link rel="prefetch" href="/assets/js/47.0e4b18e7.js"><link rel="prefetch" href="/assets/js/48.21e56b0a.js"><link rel="prefetch" href="/assets/js/49.28eb16aa.js"><link rel="prefetch" href="/assets/js/5.7098d77a.js"><link rel="prefetch" href="/assets/js/50.7bec212f.js"><link rel="prefetch" href="/assets/js/51.b5f5758a.js"><link rel="prefetch" href="/assets/js/52.72a43db2.js"><link rel="prefetch" href="/assets/js/6.0c0a0f39.js"><link rel="prefetch" href="/assets/js/7.6a854e57.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.77260563.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9f84806b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/img/good.png" alt="" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="LeetCode" class="dropdown-title"><span class="title">LeetCode</span> <span class="arrow down"></span></button> <button type="button" aria-label="LeetCode" class="mobile-dropdown-title"><span class="title">LeetCode</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          二叉树
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/language/chinese/" class="nav-link">
  Installation
</a></li><li class="dropdown-subitem"><a href="/language/japanese/" class="nav-link">
  xxx
</a></li></ul></li><li class="dropdown-item"><h4>
          滑动窗口
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/language/chinese/" class="nav-link">
  Installation
</a></li><li class="dropdown-subitem"><a href="/language/japanese/" class="nav-link">
  xxx
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Chip" class="dropdown-title"><span class="title">Chip</span> <span class="arrow down"></span></button> <button type="button" aria-label="Chip" class="mobile-dropdown-title"><span class="title">Chip</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          一生一芯
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Chip/Chip/一生一芯计划.html" class="nav-link">
  预学习
</a></li><li class="dropdown-subitem"><a href="/language/japanese/" class="nav-link">
  B阶段
</a></li><li class="dropdown-subitem"><a href="/language/japanese/" class="nav-link">
  A阶段
</a></li></ul></li><li class="dropdown-item"><h4>
          Chisel
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Chip/Chip/2024.02.21-Chisel.html" class="nav-link">
  Bootcamp
</a></li><li class="dropdown-subitem"><a href="/language/japanese/" class="nav-link">
  xxx
</a></li></ul></li><li class="dropdown-item"><h4>
          Verilog
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Chip/Chip/2023.11.07-Verilog语法.html" class="nav-link">
  Basic
</a></li><li class="dropdown-subitem"><a href="/language/japanese/" class="nav-link">
  xxx
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="LeetCode" class="dropdown-title"><span class="title">LeetCode</span> <span class="arrow down"></span></button> <button type="button" aria-label="LeetCode" class="mobile-dropdown-title"><span class="title">LeetCode</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          二叉树
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/language/chinese/" class="nav-link">
  Installation
</a></li><li class="dropdown-subitem"><a href="/language/japanese/" class="nav-link">
  xxx
</a></li></ul></li><li class="dropdown-item"><h4>
          滑动窗口
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/language/chinese/" class="nav-link">
  Installation
</a></li><li class="dropdown-subitem"><a href="/language/japanese/" class="nav-link">
  xxx
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Chip" class="dropdown-title"><span class="title">Chip</span> <span class="arrow down"></span></button> <button type="button" aria-label="Chip" class="mobile-dropdown-title"><span class="title">Chip</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          一生一芯
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Chip/Chip/一生一芯计划.html" class="nav-link">
  预学习
</a></li><li class="dropdown-subitem"><a href="/language/japanese/" class="nav-link">
  B阶段
</a></li><li class="dropdown-subitem"><a href="/language/japanese/" class="nav-link">
  A阶段
</a></li></ul></li><li class="dropdown-item"><h4>
          Chisel
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Chip/Chip/2024.02.21-Chisel.html" class="nav-link">
  Bootcamp
</a></li><li class="dropdown-subitem"><a href="/language/japanese/" class="nav-link">
  xxx
</a></li></ul></li><li class="dropdown-item"><h4>
          Verilog
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Chip/Chip/2023.11.07-Verilog语法.html" class="nav-link">
  Basic
</a></li><li class="dropdown-subitem"><a href="/language/japanese/" class="nav-link">
  xxx
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>2024 02 21 Chisel</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Chip/Chip/2024.02.21-Chisel/2024.02.21-1 Introduction to Scala.html" class="sidebar-link">2024.02.21-1. Introduction to Scala</a></li><li><a href="/Chip/Chip/2024.02.21-Chisel/2024.02.23-2.1 First Chisel Module.html" class="sidebar-link">2024.02.23-2.1 First Chisel Module</a></li><li><a href="/Chip/Chip/2024.02.21-Chisel/2024.02.24-2.2 Combinational Logic.html" class="sidebar-link">2024.02.24-2.2 Combinational Logic</a></li><li><a href="/Chip/Chip/2024.02.21-Chisel/2024.02.25-2.3 Control Flow.html" class="sidebar-link">2024.02.25-2.3 Control Flow</a></li><li><a href="/Chip/Chip/2024.02.21-Chisel/2024.02.26-2.4 Sequential Logic.html" class="active sidebar-link">2024.02.26-2.4 Sequential Logic</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Chip/Chip/2024.02.21-Chisel/2024.02.26-2.4 Sequential Logic.html#registers" class="sidebar-link">Registers</a></li><li class="sidebar-sub-header"><a href="/Chip/Chip/2024.02.21-Chisel/2024.02.26-2.4 Sequential Logic.html#shift-register" class="sidebar-link">Shift Register</a></li><li class="sidebar-sub-header"><a href="/Chip/Chip/2024.02.21-Chisel/2024.02.26-2.4 Sequential Logic.html#appendix-explicit-clock-and-reset" class="sidebar-link">Appendix: Explicit clock and reset</a></li></ul></li><li><a href="/Chip/Chip/2024.02.21-Chisel/2024.02.28-2.5 FIR Filter.html" class="sidebar-link">2024.02.28-2.5 FIR Filter</a></li><li><a href="/Chip/Chip/2024.02.21-Chisel/2024.02.29-2.6 More on ChiselTest.html" class="sidebar-link">2024.02.29-2.6 More on ChiselTest</a></li><li><a href="/Chip/Chip/2024.02.21-Chisel/2024.03.01-3.1 Generators Parameters.html" class="sidebar-link">2024.03.01-3.1 Generators: Parameters</a></li><li><a href="/Chip/Chip/2024.02.21-Chisel/2024.03.03-3.2 Generators Collections.html" class="sidebar-link">2024.03.03-3.2 Generators: Collections</a></li><li><a href="/Chip/Chip/2024.02.21-Chisel/2024.03.04-3.3 Interlude Chisel Standard Library.html" class="sidebar-link">2024.03.04-3.3 Interlude: Chisel Standard Library</a></li><li><a href="/Chip/Chip/2024.02.21-Chisel/2024.03.05-3.4 Higher-Order Functions.html" class="sidebar-link">2024.03.05-3.4 Higher-Order Functions</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_2024-02-26-2-4-sequential-logic"><a href="#_2024-02-26-2-4-sequential-logic" class="header-anchor">#</a> 2024.02.26-2.4 Sequential Logic</h1> <h2 id="registers"><a href="#registers" class="header-anchor">#</a> Registers</h2> <p>A <code>Reg</code> holds its output value until the rising edge of its clock, at which time it takes on the value of its input.</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">class</span> RegisterModule <span class="token keyword">extends</span> Module <span class="token punctuation">{</span>
  <span class="token keyword">val</span> io <span class="token operator">=</span> IO<span class="token punctuation">(</span><span class="token keyword">new</span> Bundle <span class="token punctuation">{</span>
    <span class="token keyword">val</span> in  <span class="token operator">=</span> Input<span class="token punctuation">(</span>UInt<span class="token punctuation">(</span><span class="token number">12.</span>W<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> out <span class="token operator">=</span> Output<span class="token punctuation">(</span>UInt<span class="token punctuation">(</span><span class="token number">12.</span>W<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  
	<span class="token comment">// val register : UInt = Reg(UInt(12.W))</span>
  <span class="token keyword">val</span> register <span class="token operator">=</span> Reg<span class="token punctuation">(</span>UInt<span class="token punctuation">(</span><span class="token number">12.</span>W<span class="token punctuation">)</span><span class="token punctuation">)</span>
  register <span class="token operator">:</span><span class="token operator">=</span> io<span class="token punctuation">.</span>in <span class="token operator">+</span> <span class="token number">1.</span>U
  io<span class="token punctuation">.</span>out <span class="token operator">:</span><span class="token operator">=</span> register
<span class="token punctuation">}</span>

test<span class="token punctuation">(</span><span class="token keyword">new</span> RegisterModule<span class="token punctuation">)</span> <span class="token punctuation">{</span> c <span class="token keyword">=&gt;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">&lt;-</span> <span class="token number">0</span> until <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c<span class="token punctuation">.</span>io<span class="token punctuation">.</span>in<span class="token punctuation">.</span>poke<span class="token punctuation">(</span>i<span class="token punctuation">.</span>U<span class="token punctuation">)</span>
    c<span class="token punctuation">.</span>clock<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span>io<span class="token punctuation">.</span>out<span class="token punctuation">.</span>expect<span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>U<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
println<span class="token punctuation">(</span><span class="token string">&quot;SUCCESS!!&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>Notice: One important note is that Chisel distinguishes between types (like <code>UInt</code>) and hardware nodes (like the literal <code>2.U</code>, or the output of <code>myReg</code>).</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">// legal because a Reg needs a data type as a model</span>
<span class="token keyword">val</span> myReg <span class="token operator">=</span> Reg<span class="token punctuation">(</span>UInt<span class="token punctuation">(</span><span class="token number">2.</span>W<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// error because `2.U` is already a hardware node and can't be used as a model</span>
<span class="token keyword">val</span> myReg <span class="token operator">=</span> Reg<span class="token punctuation">(</span><span class="token number">2.</span>U<span class="token punctuation">)</span>
</code></pre></div><h3 id="reginit"><a href="#reginit" class="header-anchor">#</a> <code>RegInit</code></h3> <p>The register in <code>RegisterModule</code> was initialized to random data for simulation. Unless otherwised specified, registers do not have a reset value (or a reset). The way to create a register that resets to a given value is with <code>RegInit</code>.</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">// The first argument is a type node that specified the datatype and its width.</span>
<span class="token comment">// The second argument is a hardware node that specified the reset value, in this case 0.</span>
<span class="token keyword">val</span> myReg <span class="token operator">=</span> RegInit<span class="token punctuation">(</span>UInt<span class="token punctuation">(</span><span class="token number">12.</span>W<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.</span>U<span class="token punctuation">)</span>

<span class="token comment">// It is a hardware node that specifies the reset value, but normally `0.U`.</span>
<span class="token keyword">val</span> myReg <span class="token operator">=</span> RegInit<span class="token punctuation">(</span><span class="token number">0.</span>U<span class="token punctuation">(</span><span class="token number">12.</span>W<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p><code>RegInit</code> 不仅初始化，也创建了这个reg，因此不需要先创建再init</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">class</span> RegInitModule <span class="token keyword">extends</span> Module <span class="token punctuation">{</span>
  <span class="token keyword">val</span> io <span class="token operator">=</span> IO<span class="token punctuation">(</span><span class="token keyword">new</span> Bundle <span class="token punctuation">{</span>
    <span class="token keyword">val</span> in  <span class="token operator">=</span> Input<span class="token punctuation">(</span>UInt<span class="token punctuation">(</span><span class="token number">12.</span>W<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> out <span class="token operator">=</span> Output<span class="token punctuation">(</span>UInt<span class="token punctuation">(</span><span class="token number">12.</span>W<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  
  <span class="token keyword">val</span> register <span class="token operator">=</span> RegInit<span class="token punctuation">(</span><span class="token number">0.</span>U<span class="token punctuation">(</span><span class="token number">12.</span>W<span class="token punctuation">)</span><span class="token punctuation">)</span>
  register <span class="token operator">:</span><span class="token operator">=</span> io<span class="token punctuation">.</span>in <span class="token operator">+</span> <span class="token number">1.</span>U
  io<span class="token punctuation">.</span>out <span class="token operator">:</span><span class="token operator">=</span> register
<span class="token punctuation">}</span>
</code></pre></div><h3 id="regnext"><a href="#regnext" class="header-anchor">#</a> <code>RegNext</code></h3> <p><strong><code>RegNext</code></strong> 在 Chisel 中是一个用于创建寄存器并在下一个时钟周期将输入信号的值传递给该寄存器的便捷方法。它简化了寄存器的声明和初始化，使得您可以轻松地创建一个将当前输入信号的值保存到下一个时钟周期的寄存器。使用**<code>RegNext</code>**时，可以指定一个初始值，如果不指定，则寄存器在复位时的值是未定义的</p> <p>在 Chisel 中使用 <strong><code>RegNext</code></strong> 的基本语法如下：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> myReg <span class="token operator">=</span> RegNext<span class="token punctuation">(</span>inputSignal<span class="token punctuation">,</span> initValue<span class="token punctuation">)</span>
</code></pre></div><ul><li><strong><code>inputSignal</code></strong> 是你希望在下一个时钟周期传递给寄存器的信号。</li> <li><strong><code>initValue</code></strong> 是可选参数，用于指定寄存器在复位时的初始值。如果不提供初始值，寄存器在复位时的值是未定义的。</li></ul> <h2 id="shift-register"><a href="#shift-register" class="header-anchor">#</a> Shift Register</h2> <p><img src="2024%2002%2026-2%204%20Sequential%20Logic%204c420f3d5c0f4fe7b688f3a295c6e8c6/Untitled.svg" alt="Untitled"></p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">class</span> MyShiftRegister<span class="token punctuation">(</span><span class="token keyword">val</span> init<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> Module <span class="token punctuation">{</span>
  <span class="token keyword">val</span> io <span class="token operator">=</span> IO<span class="token punctuation">(</span><span class="token keyword">new</span> Bundle <span class="token punctuation">{</span>
    <span class="token keyword">val</span> in  <span class="token operator">=</span> Input<span class="token punctuation">(</span>Bool<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> out <span class="token operator">=</span> Output<span class="token punctuation">(</span>UInt<span class="token punctuation">(</span><span class="token number">4.</span>W<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">val</span> state <span class="token operator">=</span> RegInit<span class="token punctuation">(</span>UInt<span class="token punctuation">(</span><span class="token number">4.</span>W<span class="token punctuation">)</span><span class="token punctuation">,</span> init<span class="token punctuation">.</span>U<span class="token punctuation">)</span>
  <span class="token keyword">val</span> stateTemp <span class="token operator">=</span> <span class="token punctuation">(</span>state <span class="token operator">&lt;&lt;</span> <span class="token number">1.</span>U<span class="token punctuation">)</span> <span class="token operator">+</span> io<span class="token punctuation">.</span>in<span class="token punctuation">.</span>asUInt
  state <span class="token operator">:</span><span class="token operator">=</span> stateTemp
  io<span class="token punctuation">.</span>out <span class="token operator">:</span><span class="token operator">=</span> state
<span class="token punctuation">}</span>

test<span class="token punctuation">(</span><span class="token keyword">new</span> MyShiftRegister<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> c <span class="token keyword">=&gt;</span>
  <span class="token keyword">var</span> state <span class="token operator">=</span> c<span class="token punctuation">.</span>init
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">&lt;-</span> <span class="token number">0</span> until <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// poke in LSB of i (i % 2)</span>
    c<span class="token punctuation">.</span>io<span class="token punctuation">.</span>in<span class="token punctuation">.</span>poke<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>B<span class="token punctuation">)</span>
    <span class="token comment">// update expected state</span>
    state <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>state <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xf</span>
    c<span class="token punctuation">.</span>clock<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span>io<span class="token punctuation">.</span>out<span class="token punctuation">.</span>expect<span class="token punctuation">(</span>state<span class="token punctuation">.</span>U<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
println<span class="token punctuation">(</span><span class="token string">&quot;SUCCESS!!&quot;</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="parameterized-shift-register"><a href="#parameterized-shift-register" class="header-anchor">#</a> Parameterized Shift Register</h3> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">// n is the output width (number of delays - 1)</span>
<span class="token comment">// init state to init</span>
<span class="token keyword">class</span> MyOptionalShiftRegister<span class="token punctuation">(</span><span class="token keyword">val</span> n<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token keyword">val</span> init<span class="token operator">:</span> BigInt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> Module <span class="token punctuation">{</span>
  <span class="token keyword">val</span> io <span class="token operator">=</span> IO<span class="token punctuation">(</span><span class="token keyword">new</span> Bundle <span class="token punctuation">{</span>
    <span class="token keyword">val</span> en  <span class="token operator">=</span> Input<span class="token punctuation">(</span>Bool<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> in  <span class="token operator">=</span> Input<span class="token punctuation">(</span>Bool<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> out <span class="token operator">=</span> Output<span class="token punctuation">(</span>UInt<span class="token punctuation">(</span>n<span class="token punctuation">.</span>W<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">val</span> state <span class="token operator">=</span> RegInit<span class="token punctuation">(</span>init<span class="token punctuation">.</span>U<span class="token punctuation">(</span>n<span class="token punctuation">.</span>W<span class="token punctuation">)</span><span class="token punctuation">)</span>

  when<span class="token punctuation">(</span>io<span class="token punctuation">.</span>en<span class="token punctuation">)</span><span class="token punctuation">{</span>
    state <span class="token operator">:</span><span class="token operator">=</span> state <span class="token operator">&lt;&lt;</span> <span class="token number">1</span> <span class="token operator">|</span> io<span class="token punctuation">.</span>in
  <span class="token punctuation">}</span>
  io<span class="token punctuation">.</span>out <span class="token operator">:</span><span class="token operator">=</span> state
<span class="token punctuation">}</span>

<span class="token comment">// test different depths</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">&lt;-</span> Seq<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  println<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">&quot;Testing n=</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">i</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
  test<span class="token punctuation">(</span><span class="token keyword">new</span> MyOptionalShiftRegister<span class="token punctuation">(</span>n <span class="token operator">=</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> c <span class="token keyword">=&gt;</span>
    <span class="token keyword">val</span> inSeq <span class="token operator">=</span> Seq<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> state <span class="token operator">=</span> c<span class="token punctuation">.</span>init
    <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span>
    c<span class="token punctuation">.</span>io<span class="token punctuation">.</span>en<span class="token punctuation">.</span>poke<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">.</span>B<span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token operator">*</span> c<span class="token punctuation">.</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// poke in repeated inSeq</span>
      <span class="token keyword">val</span> toPoke <span class="token operator">=</span> inSeq<span class="token punctuation">(</span>i <span class="token operator">%</span> inSeq<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
      c<span class="token punctuation">.</span>io<span class="token punctuation">.</span>in<span class="token punctuation">.</span>poke<span class="token punctuation">(</span><span class="token punctuation">(</span>toPoke <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>B<span class="token punctuation">)</span>
      <span class="token comment">// update expected state</span>
      state <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>state <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> toPoke<span class="token punctuation">)</span> <span class="token operator">&amp;</span> BigInt<span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token operator">*</span>c<span class="token punctuation">.</span>n<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
      c<span class="token punctuation">.</span>clock<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
      c<span class="token punctuation">.</span>io<span class="token punctuation">.</span>out<span class="token punctuation">.</span>expect<span class="token punctuation">(</span>state<span class="token punctuation">.</span>U<span class="token punctuation">)</span>

      i <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
println<span class="token punctuation">(</span><span class="token string">&quot;SUCCESS!!&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>Notice: Chisel中变量被声明为常量<code>val</code>，因此一个变量只能被赋值一次，因为这表示硬件电路连接，但是会根据输入等的不同而具有不同的值。因此不能多次给一个变量赋值，如果需要，可以把中间值重新命名为一个<code>val</code>来调用</p> <h2 id="appendix-explicit-clock-and-reset"><a href="#appendix-explicit-clock-and-reset" class="header-anchor">#</a> Appendix: Explicit clock and reset</h2> <p>Chisel模块默认使用隐式的时钟和复位信号，每个内部创建的寄存器都会使用这些默认信号。在某些情况下，你可能需要覆盖这种默认行为，比如使用生成时钟或复位信号的黑盒，或者设计多时钟系统。Chisel提供了**<code>withClock() {}</code><strong>、</strong><code>withReset() {}</code><strong>和</strong><code>withClockAndReset() {}</code><strong>等构造来处理这些情况，允许分别或同时覆盖时钟和复位。需要注意的是，至本教程编写时，复位信号总是同步的并且是</strong><code>Bool</code><strong>类型。时钟在Chisel中有其自身的类型（</strong><code>Clock</code><strong>），并且应该相应声明。</strong><code>Bool</code><strong>类型可以通过调用</strong><code>asClock()</code><strong>转换为</strong><code>Clock</code><strong>类型，但需要确保这样做是合理的。同时，</strong><code>chisel-testers</code>**目前对多时钟设计的支持并不完全。</p> <h3 id="example-multi-clock-module"><a href="#example-multi-clock-module" class="header-anchor">#</a> Example: Multi-Clock Module</h3> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">// we need to import multi-clock features</span>
<span class="token keyword">import</span> <span class="token namespace">chisel3<span class="token punctuation">.</span>experimental<span class="token punctuation">.</span></span><span class="token punctuation">{</span>withClock<span class="token punctuation">,</span> withReset<span class="token punctuation">,</span> withClockAndReset<span class="token punctuation">}</span>

<span class="token keyword">class</span> ClockExamples <span class="token keyword">extends</span> Module <span class="token punctuation">{</span>
  <span class="token keyword">val</span> io <span class="token operator">=</span> IO<span class="token punctuation">(</span><span class="token keyword">new</span> Bundle <span class="token punctuation">{</span>
    <span class="token keyword">val</span> in <span class="token operator">=</span> Input<span class="token punctuation">(</span>UInt<span class="token punctuation">(</span><span class="token number">10.</span>W<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> alternateReset    <span class="token operator">=</span> Input<span class="token punctuation">(</span>Bool<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> alternateClock    <span class="token operator">=</span> Input<span class="token punctuation">(</span>Clock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> outImplicit       <span class="token operator">=</span> Output<span class="token punctuation">(</span>UInt<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> outAlternateReset <span class="token operator">=</span> Output<span class="token punctuation">(</span>UInt<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> outAlternateClock <span class="token operator">=</span> Output<span class="token punctuation">(</span>UInt<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> outAlternateBoth  <span class="token operator">=</span> Output<span class="token punctuation">(</span>UInt<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">val</span> imp <span class="token operator">=</span> RegInit<span class="token punctuation">(</span><span class="token number">0.</span>U<span class="token punctuation">(</span><span class="token number">10.</span>W<span class="token punctuation">)</span><span class="token punctuation">)</span>
  imp <span class="token operator">:</span><span class="token operator">=</span> io<span class="token punctuation">.</span>in
  io<span class="token punctuation">.</span>outImplicit <span class="token operator">:</span><span class="token operator">=</span> imp

  withReset<span class="token punctuation">(</span>io<span class="token punctuation">.</span>alternateReset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// everything in this scope with have alternateReset as the reset</span>
    <span class="token keyword">val</span> altRst <span class="token operator">=</span> RegInit<span class="token punctuation">(</span><span class="token number">0.</span>U<span class="token punctuation">(</span><span class="token number">10.</span>W<span class="token punctuation">)</span><span class="token punctuation">)</span>
    altRst <span class="token operator">:</span><span class="token operator">=</span> io<span class="token punctuation">.</span>in
    io<span class="token punctuation">.</span>outAlternateReset <span class="token operator">:</span><span class="token operator">=</span> altRst
  <span class="token punctuation">}</span>

  withClock<span class="token punctuation">(</span>io<span class="token punctuation">.</span>alternateClock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> altClk <span class="token operator">=</span> RegInit<span class="token punctuation">(</span><span class="token number">0.</span>U<span class="token punctuation">(</span><span class="token number">10.</span>W<span class="token punctuation">)</span><span class="token punctuation">)</span>
    altClk <span class="token operator">:</span><span class="token operator">=</span> io<span class="token punctuation">.</span>in
    io<span class="token punctuation">.</span>outAlternateClock <span class="token operator">:</span><span class="token operator">=</span> altClk
  <span class="token punctuation">}</span>

  withClockAndReset<span class="token punctuation">(</span>io<span class="token punctuation">.</span>alternateClock<span class="token punctuation">,</span> io<span class="token punctuation">.</span>alternateReset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> alt <span class="token operator">=</span> RegInit<span class="token punctuation">(</span><span class="token number">0.</span>U<span class="token punctuation">(</span><span class="token number">10.</span>W<span class="token punctuation">)</span><span class="token punctuation">)</span>
    alt <span class="token operator">:</span><span class="token operator">=</span> io<span class="token punctuation">.</span>in
    io<span class="token punctuation">.</span>outAlternateBoth <span class="token operator">:</span><span class="token operator">=</span> alt
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

println<span class="token punctuation">(</span>getVerilog<span class="token punctuation">(</span><span class="token keyword">new</span> ClockExamples<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>通过**<code>import chisel3.experimental.{withClock, withReset, withClockAndReset}</code><strong>引入了多时钟特性。</strong><code>ClockExamples</code><strong>模块定义了一个10位宽的输入</strong><code>io.in</code><strong>，以及替代的复位和时钟信号</strong><code>io.alternateReset</code><strong>和</strong><code>io.alternateClock</code>**。模块输出了四种不同情况下的寄存器值：使用默认时钟和复位、只替换复位、只替换时钟、同时替换时钟和复位。</p> <ol><li><strong><code>withReset(io.alternateReset) {...}</code><strong>块定义了一个新的作用域，其中所有寄存器的复位信号被替换为</strong><code>io.alternateReset</code></strong>。在这个作用域内，**<code>altRst</code><strong>寄存器在被替代复位信号复位时初始化为0，并在每个时钟周期将</strong><code>io.in</code>**的值赋给它。</li> <li><strong><code>withClock(io.alternateClock) {...}</code><strong>块定义了另一个作用域，其中所有寄存器的时钟信号被替换为</strong><code>io.alternateClock</code></strong>。在这个作用域内，**<code>altClk</code><strong>寄存器在被替代时钟信号驱动时初始化为0，并在每个时钟周期将</strong><code>io.in</code>**的值赋给它。</li> <li><strong><code>withClockAndReset(io.alternateClock, io.alternateReset) {...}</code><strong>块同时替换了寄存器的时钟和复位信号为</strong><code>io.alternateClock</code><strong>和</strong><code>io.alternateReset</code></strong>。在这个作用域内，**<code>alt</code><strong>寄存器同时被替代的时钟和复位信号控制，初始化为0，并在每个时钟周期将</strong><code>io.in</code>**的值赋给它。</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Chip/Chip/2024.02.21-Chisel/2024.02.25-2.3 Control Flow.html" class="prev">
        2024.02.25-2.3 Control Flow
      </a></span> <span class="next"><a href="/Chip/Chip/2024.02.21-Chisel/2024.02.28-2.5 FIR Filter.html">
        2024.02.28-2.5 FIR Filter
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.aca65f08.js" defer></script><script src="/assets/js/2.0c4bddf9.js" defer></script><script src="/assets/js/1.50b457b8.js" defer></script><script src="/assets/js/35.3ddbf166.js" defer></script>
  </body>
</html>
